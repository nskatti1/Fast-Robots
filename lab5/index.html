

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lab 5: Linear PID control and Linear interpolation &mdash; Fast Robots ECE 4160  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=187304be"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Lab 6: Orientation Control" href="../lab6/" />
    <link rel="prev" title="Lab 4: Motors and Open Loop Control" href="../lab4/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            Fast Robots ECE 4160
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lab1/">Lab 1: The Artemis Board and Bluetooth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab2/">Lab 2: Sensor Fusion and High-Speed Data Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/">Lab 3: TOF Sensor Integration and Performance Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab4/">Lab 4: Motors and Open Loop Control</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab 5: Linear PID control and Linear interpolation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#attempt-1">Attempt 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prelab">Prelab</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#estimating-distance">Estimating Distance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#positional-control-task-videos-and-corresponding-graphs">Positional Control Task Videos and Corresponding Graphs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extrapolation-code">Extrapolation Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#reflection">Reflection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/">Lab 6: Orientation Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab7/">Lab 7: Kalman Filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab8/">Lab 8: Stunts!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab9/">Lab 9: Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab10/">Lab 10: Localization (sim)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab11/">Lab 11: Localization (real)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab12/">Lab 12: Self-Flippable Inverted Pendulum Car</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">Fast Robots ECE 4160</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Lab 5: Linear PID control and Linear interpolation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/lab5.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="lab-5-linear-pid-control-and-linear-interpolation">
<h1>Lab 5: Linear PID control and Linear interpolation<a class="headerlink" href="#lab-5-linear-pid-control-and-linear-interpolation" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#attempt-1" id="id1">Attempt 1</a></p></li>
<li><p><a class="reference internal" href="#prelab" id="id2">Prelab</a></p>
<ul>
<li><p><a class="reference internal" href="#estimating-distance" id="id3">Estimating Distance</a></p></li>
<li><p><a class="reference internal" href="#positional-control-task-videos-and-corresponding-graphs" id="id4">Positional Control Task Videos and Corresponding Graphs</a></p></li>
<li><p><a class="reference internal" href="#extrapolation-code" id="id5">Extrapolation Code</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#reflection" id="id6">Reflection</a></p></li>
<li><p><a class="reference internal" href="#acknowledgements" id="id7">Acknowledgements</a></p></li>
</ul>
</nav>
<section id="attempt-1">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Attempt 1</a><a class="headerlink" href="#attempt-1" title="Link to this heading"></a></h2>
<p>I did the lab twice as I messed up the first time and collected the data in python and created the P Controller in python instead of C. I wrote more about my thoughts below in the reflection. Since I did spend a lot of time on this, I still wanted to include it on my page. While it did work, it was not a good controller. My car moved too slowly. My PWM values were between 42 and 39 where 39 is nearly the closest value to stopping.</p>
<p>In C I wrote 2 functions, one function that measured and sent the data back and the other function that took in a PWM value and wrote it to the motors.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="no">PID_MEASURE</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="n">distanceSensor</span><span class="p">.</span><span class="n">startRanging</span><span class="p">();</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">distanceSensor</span><span class="p">.</span><span class="n">checkForDataReady</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">curr_distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distanceSensor</span><span class="p">.</span><span class="n">getDistance</span><span class="p">();</span>
<span class="w">  </span><span class="n">distanceSensor</span><span class="p">.</span><span class="n">clearInterrupt</span><span class="p">();</span>
<span class="w">  </span><span class="n">distanceSensor</span><span class="p">.</span><span class="n">stopRanging</span><span class="p">();</span>


<span class="w">  </span><span class="n">tx_characteristic_string</span><span class="p">.</span><span class="n">writeValue</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">//  Force reset BLE buffer</span>


<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">curr_d</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
<span class="w">  </span><span class="n">String</span><span class="p">(</span><span class="n">curr_distance</span><span class="p">).</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">curr_d</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">curr_d</span><span class="p">));</span>


<span class="w">  </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">  </span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_d</span><span class="p">);</span>
<span class="w">  </span><span class="n">tx_characteristic_string</span><span class="p">.</span><span class="n">writeValue</span><span class="p">(</span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

<span class="w">  </span><span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="no">PID_UPDATE</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">received_pwm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">robot_cmd</span><span class="p">.</span><span class="n">get_next_value</span><span class="p">(</span><span class="n">received_pwm</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Apply received PWM to motors</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">received_pwm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">stop_motors</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">move_motors</span><span class="p">(</span><span class="n">received_pwm</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>On the flip side, I create a loop in python and set some constants.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Kp</span> <span class="o">=</span> <span class="mf">0.06899</span><span class="o">/</span><span class="mi">7</span>
<span class="n">TARGET_DISTANCE</span> <span class="o">=</span> <span class="mi">304</span>
<span class="n">DEADBAND</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">MAX_RANGE</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">MAX_PWM</span> <span class="o">=</span> <span class="mi">255</span>
<span class="n">MIN_PWM</span> <span class="o">=</span> <span class="mi">39</span>
</pre></div>
</div>
<p>Then I create a loop that ran through the commands
I first started with a P Controller, though it did not work the best. My loop in python stored and printed the different values of time, distance, and PWM value.
In my PID loop, I just sent a command that requested the TOF data, calculated the PWM values, and then sent that to the Redboard Nano. Because of the nature of the loop, I sampled my TOF data once every single loop regardless of whether the data was ready or not. I recorded the times at which I sampled these values. That was the frequency at which my PID loop ran. I attached some videos of tbe P controller that I made below. I was not happy with my work and decided to redo the lab.</p>
<p>Here are videos of my controller.</p>
</section>
<section id="prelab">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Prelab</a><a class="headerlink" href="#prelab" title="Link to this heading"></a></h2>
<p>Now for my actual prelab, I used a function to send all my data to python the pid loop runs.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<dl>
<dt>void send_pid_data_to_python() {</dt><dd><p>tx_characteristic_string.writeValue(“”);  // Clear buffer</p>
<dl>
<dt>for (int i = 0; i &lt; sample_count; i++) {</dt><dd><dl class="simple">
<dt>String data = String(timestamps[i]) + “|” +</dt><dd><p>String(distances[i]) + “|” +
String(step_function_distances[i]) + “|” +
String(extrapolated_distances[i]) + “|” +
String(kp_terms[i], 4) + “|” +
String(ki_terms[i], 4) + “|” +
String(kd_terms[i], 4) + “|” +
String(pwm_values[i]);</p>
</dd>
</dl>
<p>tx_characteristic_string.writeValue(data.c_str());
delay(50);</p>
</dd>
</dl>
</dd>
</dl>
<p>I then used my notification handler and the ble.start_notify() function to get my results on python for plotting.
Lab
————————————————————————–
Frequency of TOF Sensor and PID Loop
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p>
<section id="estimating-distance">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Estimating Distance</a><a class="headerlink" href="#estimating-distance" title="Link to this heading"></a></h3>
</section>
<section id="positional-control-task-videos-and-corresponding-graphs">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Positional Control Task Videos and Corresponding Graphs</a><a class="headerlink" href="#positional-control-task-videos-and-corresponding-graphs" title="Link to this heading"></a></h3>
<p>The following are videos of my PID loop.</p>
</section>
<section id="extrapolation-code">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Extrapolation Code</a><a class="headerlink" href="#extrapolation-code" title="Link to this heading"></a></h3>
<p>The following code was used for extrapolation</p>
</section>
</section>
<section id="reflection">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Reflection</a><a class="headerlink" href="#reflection" title="Link to this heading"></a></h2>
<p>I redid the lab, so I could put the control loop as close to the hardware as possible and try to make a better loop. I found that doing it in python takes time because I had to send the values. While C compiles longer, it executes faster than python. I was very unhappy with my first results. Overall, I am proud of the work I did. Even though the first part was not a great controller, I am happy I took the time to try to tune it as best I could. I learned a lot and I worked hard. Success!</p>
</section>
<section id="acknowledgements">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Acknowledgements</a><a class="headerlink" href="#acknowledgements" title="Link to this heading"></a></h2>
<p>Credits to Mikayla Lahr for being an awesome TA . I also looked at her solutions and implemented a similar Kp Value(I ended up dividing hers by 5). This got to me a starting place when I had spent a lot of time running my car into a wall. Thanks to Aravind Ramaswami for picking up a battery for me when I battery was bad and Annabel for working along side me when I was figuring out whether I broke my TOF sensor or not(I did not - it was the wrong port). At one point, I asked ChatGPT why my code was not working and it said to check if my battery was unplugged (it was). Thanks to Anunth Ramaswami for trying to cheer me on while accross the country as I redid the entire thing.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../lab4/" class="btn btn-neutral float-left" title="Lab 4: Motors and Open Loop Control" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../lab6/" class="btn btn-neutral float-right" title="Lab 6: Orientation Control" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Nita Kattimani.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>